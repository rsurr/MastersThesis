---
title: "Ask the data"
author: "Rodrigo Surraco"
date: "2024-04-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1. Los pacientes descompensados se quedan más en el centro de su prestador?

```{r descom}

occupancy <- read_csv("OCCUPANCY.CSV")
INGRESOS_HD2 <- read_csv("INGRESOS_HD2.csv")

DATA <- 
  left_join(occupancy, INGRESOS_HD2, by=c("mes_solicitud", "ZCAIMAE")) %>% 
  dummy_cols(select_columns = c("tipo_inst", "SCDESU")) %>% 
  mutate(ingresos=if_else(is.na(CAPACNUM), 0, 1))

DATA %>% group_by(SCDESU) %>% summarise(inst_imae=mean(inst_imae, na.rm=T))
```

No.

# 2. Los centros admiten más pacientes descompensados o de prestadores públicos cuanto más espacio tienen (seleccionan)?

```{r occupancy}

occupancy <- read_csv("OCCUPANCY.CSV")
INGRESOS_HD2 <- read_csv("INGRESOS_HD2.csv")

DATA <- 
  left_join(occupancy, INGRESOS_HD2, by=c("mes_solicitud", "ZCAIMAE")) %>% 
  dummy_cols(select_columns = c("tipo_inst", "SCDESU")) %>% 
  mutate(ingresos=if_else(is.na(CAPACNUM), 0, 1))

DATA2 <- DATA  %>% 
  group_by(mes_solicitud, ZCAIMAE) %>% 
  summarise(slack=mean(slack, na.rm=T),
            slack_perc=mean(slack_perc, na.rm=T),
            tipo_inst_ASSE=mean(tipo_inst_ASSE, na.rm=T),
            SCDESU_S=mean(SCDESU_S, na.rm=T),
            ingresos=sum(ingresos))

DATA2 %>% ungroup() %>% select(-c(mes_solicitud, ZCAIMAE)) %>% cor(use = "pairwise.complete.obs")
```

No.


# 3. Qué centros admiten más pacientes descompensados y de ASSE?

```{r occupancy}

occupancy <- read_csv("OCCUPANCY.CSV")
INGRESOS_HD2 <- read_csv("INGRESOS_HD2.csv")

DATA <- 
  left_join(occupancy, INGRESOS_HD2, by=c("mes_solicitud", "ZCAIMAE")) %>% 
  dummy_cols(select_columns = c("tipo_inst", "SCDESU")) %>% 
  mutate(ingresos=if_else(is.na(CAPACNUM), 0, 1))

DATA3 <- DATA  %>% 
  group_by(ZCAIMAE) %>% 
  summarise(slack=mean(slack, na.rm=T),
            slack_perc=mean(slack_perc, na.rm=T),
            tipo_inst_ASSE=mean(tipo_inst_ASSE, na.rm=T),
            SCDESU_S=mean(SCDESU_S, na.rm=T),
            ingresos=sum(ingresos))

DATA3
```

No.

# 4. Qué pacientes están en INGRESOS y en MENSUALES e SESIONES?

```{r}

aborrar <- left_join(MENSUALES_HD, INGRESOS_HD, by="CAPACNUM") %>% 
  mutate(ingreso=if_else(is.na(CASEDADA), 1, 0))

summary(aborrar$ingreso)

aborrar2 <- left_join(SESIONES_HD, INGRESOS_HD, by="CAPACNUM") %>% 
  mutate(ingreso=if_else(is.na(CASEDADA), 1, 0))

summary(aborrar2$ingreso)
```


# 5. Qué pasa si uso las variables de ocupación?

```{r}

imae <- INGRESOS_HD %>% group_by(CAIMAE) %>% summarise(CAIMAE=first(CAIMAE),
                                                       ZCAIMAE=first(ZCAIMAE))

congestion <- INFORMES_IMAES_HD %>%
  left_join(imae, by="CAIMAE") %>% 
  left_join(IMAE_num, by="ZCAIMAE") %>% 
  rowwise() %>% 
  mutate(
    #Promedio pacientes por turno en cada dia
    suma_lunes= sum(c(DNLU1O, DNLU2O, DNLU3O, DNLU4O), na.rm = T),
    Nlunes= suma_lunes/DNLUT,
    
    suma_martes=sum(c(DNMA1O, DNMA2O, DNMA3O, DNMA4O), na.rm = T),
    Nmartes= suma_martes/DNMAT,
    
    suma_miercoles=sum(c(DNMI1O, DNMI2O, DNMI3O, DNMI4O), na.rm = T),
    Nmiercoles= suma_miercoles/DNMIT,
    
    suma_jueves= sum(c(DNJU1O, DNJU2O, DNJU3O, DNJU4O), na.rm = T),
    Njueves= suma_jueves/DNJUT,
    
    suma_viernes=sum(c(DNVI1O, DNVI2O, DNVI3O, DNVI4O), na.rm = T),
    Nviernes=suma_viernes/DNVIT,
    
    suma_sabado=sum(c(DNSA1O, DNSA2O, DNSA3O, DNSA4O), na.rm = T),
    Nsabado= suma_sabado/DNSAT,
    
    #Suma por conjunto de dias
    sumaLMV=sum(c(suma_lunes, suma_miercoles, suma_viernes), na.rm = T),
    sumaMJS=sum(c(suma_martes, suma_jueves, suma_sabado), na.rm = T),
    promedio_suma=mean(c(sumaLMV, sumaMJS), na.rm=T),
    
    #Promedio conjunto de dias
    Nlmv=mean(c(Nlunes, Nmiercoles, Nviernes), na.rm = T),
    Nmjs=mean(c(Nmartes, Njueves, Nsabado), na.rm = T),
    
    Nmean=mean(c(Nlmv, Nmjs), na.rm = T),
    promedio_turnos_semana=
      mean(c(DNLUT, DNMIT, DNVIT), na.rm = T) +
      mean(c(DNMAT, DNJUT, DNSAT), na.rm = T),
    
    #Plunes= sum(c(DPLU1O, DPLU2O, DPLU3O, DPLU4O), na.rm = T)/DPLUT,
    #Pmartes= sum(c(DPMA1O, DPMA2O, DPMA3O, DPMA4O), na.rm = T)/DPMAT,
    #Pmiercoles= sum(c(DPMI1O, DPMI2O, DPMI3O, DPMI4O), na.rm = T)/DPMIT,
    #Pjueves= sum(c(DPJU1O, DPJU2O, DPJU3O, DPJU4O), na.rm = T)/DPJUT,
    #Pviernes= sum(c(DPVI1O, DPVI2O, DPVI3O, DPVI4O), na.rm = T)/DPVIT,
    #Psabado= sum(c(DPSA1O, DPSA2O, DPSA3O, DPSA4O), na.rm = T)/DPSAT,
    #
    #Plmv=mean(c(Plunes, Pmiercoles, Pviernes), na.rm = T),
    #Pmjs=mean(c(Pmartes, Pjueves, Psabado), na.rm = T),
    
    slack=CAHMSPBN-Nmean,
    slack_perc=slack/CAHMSPBN*100,
    
    slack2=
           if_else(slack>=10,
                   (CAHMSPBN/promedio_turnos_semana)-Nmean, slack),
    slack_perc2=slack2/CAHMSPBN*100) %>% 
  unite("fecha2", CAANIO:CAMES, sep="-") %>% 
  mutate(fecha3=as.Date(paste(fecha2, "-01", sep="")),
         mes_solicitud=format(fecha3, "%Y-%m")) %>% 
  mutate(
    tipo_imae=
      case_when(ZCAIMAE %in% c(IMAE_CENEU, IMAE_NEPHROS, IMAE_DIAVERUM, IMAE_SARI) ~ "INDEPENDIENTE",
                ZCAIMAE %in% IMAE_PUBLICO ~ "PUBLICO",
                ZCAIMAE %in% IMAE_PRIVADO ~ "PRIVADO",
                TRUE ~ NA)) %>%
    filter(depto=="01", # Filter for facilities in Montevideo
         ZCAIMAE!="SENNIAD HEMO",
         Nmean!=0,
         slack!=-102) %>% #Not pediatric
  select(slack2, slack_perc2, 
         ZCAIMAE, mes_solicitud, depto)

summary(congestion$slack)
summary(congestion$slack2)


DATA <- 
  left_join(occupancy, INGRESOS_HD2, by=c("mes_solicitud", "ZCAIMAE")) %>% 
  dummy_cols(select_columns = c("tipo_inst", "SCDESU")) %>% 
  mutate(ingresos=if_else(is.na(CAPACNUM), 0, 1))

DATA3 <- DATA  %>% 
  group_by(ZCAIMAE) %>% 
  summarise(slack=mean(slack, na.rm=T),
            slack_perc=mean(slack_perc, na.rm=T),
            tipo_inst_ASSE=mean(tipo_inst_ASSE, na.rm=T),
            SCDESU_S=mean(SCDESU_S, na.rm=T),
            ingresos=sum(ingresos),
            inst_imae=mean(inst_imae, na.rm=T))

INGRESOS_HD2 %>% group_by(ZCAIMAE) %>%
  summarise(
            inst_imae=mean(inst_imae, na.rm=T))

```


# 6. How much dialysis time?

```{r}

SESIONES_HD <- 
  read_sav("C:/Users/julie/OneDrive/Documentos/Proyecto Tesis/Databases/SESIONES HD.sav") 

head(SESIONES_HD, n=20)

summary(SESIONES_HD$DHORAS)



```


# 7. Complicaciones en la dialisis:

```{r}
table(SESIONES_HD$ZDCOMPD0)
table(SESIONES_HD$DCOMP)


aborrar <- SESIONES_HD %>% filter(DCOMPD0==184020127)
```


# 8. Where do ASSE patients go?

```{r}

asse <- INGRESOS_HD %>% filter(ZCASINST=="ASSE") %>% select(ZCAIMAE)

table(asse$ZCAIMAE) %>% as.data.frame()


```
# 9. Patients by functionality 

```{r}
table(INGRESOS_HD$exa_capacidad)

```

# 10. How many in waiting list for transplant?

```{r}
table(MENSUALES_HD$DLISTATR)

aborrar <- MENSUALES_HD %>% select(CAPACNUM, PMD_ANIO, PMD_ANIO, PMD_MES, DLISTATR)
```

Solo hay datos para diciembre, ¿por qué? (Preguntar a Opertti).

# 11. How many patients change facility?

```{r}


SESIONES_HD <- 
  read_sav("C:/Users/julie/OneDrive/Documentos/Proyecto Tesis/Databases/SESIONES HD.sav")

IMAE_ingreso <- INGRESOS_HD %>% rename(IMAE_ingreso=ZCAIMAE)

cambios <- SESIONES_HD %>%
  right_join(IMAE_ingreso, by="CAPACNUM") %>% 
  left_join(IMAE_num, by=c("ZPMD_IMAE"="ZCAIMAE")) %>% 
  group_by(CAPACNUM, ZPMD_IMAE) %>%
  summarize(n_sesiones_imae=n(), IMAE_ingreso=first(IMAE_ingreso), depto=first(depto)) %>% 
  group_by(CAPACNUM) %>% 
  mutate(
    n_imaes=n(),
    rank = row_number(-n_sesiones_imae),
    prop=n_sesiones_imae/sum(n_sesiones_imae)*100,
    cambio=if_else(rank==1,
      if_else(max(prop)!=100, 1, 0),
      NA),
    max_prop1=if_else(rank==1, prop, NA),
    max_prop2=if_else(rank==2, prop, NA),
    max_prop3=if_else(rank==3, prop, NA),
    prop_ingreso=if_else(ZPMD_IMAE==IMAE_ingreso, prop, NA),
    prop_ingreso=sum(prop_ingreso, na.rm=T),
    ingreso_max1=if_else(max_prop1==prop_ingreso, 1, 0),
    ingreso_max2=if_else(max_prop2==prop_ingreso, 1, 0),
    ingreso_max3=if_else(max_prop3==prop_ingreso, 1, 0)
    ) 
  
cambios_promedio <- cambios %>%
  filter(depto=="01",
         ZPMD_IMAE!="SENNIAD HEMO") %>% 
  mutate(
    n_imaes=n(),
    rank = row_number(-n_sesiones_imae),
    prop=n_sesiones_imae/sum(n_sesiones_imae)*100,
    cambio=if_else(rank==1,
      if_else(max(prop)!=100, 1, 0),
      NA),
    max_prop1=if_else(rank==1, prop, NA),
    max_prop2=if_else(rank==2, prop, NA),
    max_prop3=if_else(rank==3, prop, NA),
    prop_ingreso=if_else(ZPMD_IMAE==IMAE_ingreso, prop, NA),
    prop_ingreso=sum(prop_ingreso, na.rm=T),
    ingreso_max1=if_else(max_prop1==prop_ingreso, 1, 0),
    ingreso_max2=if_else(max_prop2==prop_ingreso, 1, 0),
    ingreso_max3=if_else(max_prop3==prop_ingreso, 1, 0)
    ) %>% 
  ungroup() %>% 
  summarise(
    "# facilities"=mean(n_imaes, na.rm = T),
    "% patients changing facility"=mean(cambio, na.rm = T)*100,
    "% patients having most sessions at first facility"=mean(ingreso_max1, na.rm = T)*100,
    "% sessions at first facility"=mean(prop_ingreso, na.rm = T),
    "% sessions at most attended facility"=mean(max_prop1, na.rm = T),
    "% sessions at 2nd most attended facility"=mean(max_prop2, na.rm = T),
    "% sessions at 3rd most attended facility"=mean(max_prop3, na.rm = T),
    ) %>% 
  pivot_longer(cols = everything(), names_to = "Indicator", values_to="Mean")

cambios_sd <- cambios %>%
  filter(depto=="01",
         ZPMD_IMAE!="SENNIAD HEMO") %>% 
  mutate(
    n_imaes=n(),
    rank = row_number(-n_sesiones_imae),
    prop=n_sesiones_imae/sum(n_sesiones_imae)*100,
    cambio=if_else(rank==1,
      if_else(max(prop)!=100, 1, 0),
      NA),
    max_prop1=if_else(rank==1, prop, NA),
    max_prop2=if_else(rank==2, prop, NA),
    max_prop3=if_else(rank==3, prop, NA),
    prop_ingreso=if_else(ZPMD_IMAE==IMAE_ingreso, prop, NA),
    prop_ingreso=sum(prop_ingreso, na.rm=T),
    ingreso_max1=if_else(max_prop1==prop_ingreso, 1, 0),
    ingreso_max2=if_else(max_prop2==prop_ingreso, 1, 0),
    ingreso_max3=if_else(max_prop3==prop_ingreso, 1, 0)
    ) %>%
  filter(depto=="01",
         ZPMD_IMAE!="SENNIAD HEMO") %>% 
  ungroup() %>% 
  summarise(
    "# facilities"=sd(n_imaes, na.rm = T),
    "% patients changing facility"=NA,
    "% patients having most sessions at first facility"=NA,
    "% sessions at first facility"=sd(prop_ingreso, na.rm = T),
    "% sessions at most attended facility"=sd(max_prop1, na.rm = T),
    "% sessions at 2nd most attended facility"=sd(max_prop2, na.rm = T),
    "% sessions at 3rd most attended facility"=sd(max_prop3, na.rm = T),
    ) %>% 
  pivot_longer(cols = everything(), names_to = "Indicator", values_to="SD")

tabla_cambios <- full_join(cambios_promedio, cambios_sd, by="Indicator")
  


# % que cambia 
summary(cambios$cambio)

# Numero de imaes
summary(cambios$n_imaes)

# Proporcon at 1 max imae
summary(cambios$max_prop1)

# Proporcon at 2 max imae
summary(cambios$max_prop2)

# Proporcon at 3 max imae
summary(cambios$max_prop3)

# Proporcon at 1 max imae
summary(cambios$ingreso_max1)

# Proporcon at 2 max imae
summary(cambios$ingreso_max2)

# Proporcon at 3 max imae
summary(cambios$ingreso_max3)

summary(cambios$n_imaes)

cambios_ingreso <- cambios %>% 
  filter(imae_max==1) %>% 
  mutate(ingreso_max=if_else(ZPMD_IMAE==IMAE_ingreso, 1, 0))

summary(cambios_ingreso$ingreso_max)

cambios_max2 <- cambios %>%
  filter(imae_max==0) %>% 
  group_by(CAPACNUM) %>% 
  mutate(n_imaes2=n(),
         prop2=n_sesiones_imae/sum(n_sesiones_imae),
    max2_prop=max(prop2),
         imae_max2=if_else(prop==max2_prop, 1, 0),
         cambio2=if_else(max2_prop!=1, 1, 0)) 

print(xtable::xtable(tabla_cambios, include.rownames = FALSE, file="tabla_cambios"))

```


# 12. Percentages: patient election

```{r}
LI_choice <- Logit_INGRESOS %>% 
  filter(choice==1) %>%
  summarise(
    tiene_imae=paste0(round(mean(tiene_imae, na.rm = T)*100, digits = 2), "%"),
    imae_inst=paste0(round(mean(imae_inst, na.rm = T)*100, digits = 2), "%"),
    medimae=paste0(round(mean(medimae, na.rm = T)*100, digits = 2), "%"),
    transp=paste0(round(mean(transp, na.rm = T)*100, digits = 2), "%"),
    distk=paste0(round(mean(distk, na.rm = T), digits = 2), " (", round(sd(distk, na.rm = T), digits = 2), ")"),
    delays=paste0(round(mean(delays, na.rm = T), digits = 2), " (", round(sd(delays, na.rm = T), digits = 2), ")"),
    occupancy=paste0(round(mean(occ_var, na.rm = T), digits = 2), " (", round(sd(occ_var, na.rm = T), digits = 2), ")"),
    slack_perc2=paste0(round(mean(slack_perc2, na.rm = T), digits = 2), " (", round(sd(slack_perc2, na.rm = T), digits = 2), ")"),
    slack2=paste0(round(mean(slack2, na.rm = T), digits = 2), " (", round(sd(slack2, na.rm = T), digits = 2), ")"),
    turnos=paste0(round(mean(turnos, na.rm = T), digits = 2), " (", round(sd(turnos, na.rm = T), digits = 2), ")"),
  ) %>% 
  rename("Insurance has provider"=tiene_imae,
         "Insurance"=imae_inst,
         "Nephrologist"=medimae,
         "Distance (km)"=distk,
         "Delays (days)"=delays,
         "Occupancy (#)"=occupancy,
         "Slack (%)"=slack_perc2,
         "Slack(#)"=slack2,
         "Shifts"=turnos,
         "Transport"=transp) %>% 
  pivot_longer(cols=everything(), names_to = "Indicator", values_to = "Chosen facilities")

LI_todos1 <- X_imae %>%
  group_by(tipo_imae2) %>% 
  summarise(
    #tiene_imae=paste0(round(mean(tiene_imae, na.rm = T)*100, digits = 2), "%"),
    #imae_inst=paste0(round(mean(imae_inst, na.rm = T)*100, digits = 2), "%"),
    #medimae=paste0(round(mean(medimae, na.rm = T)*100, digits = 2), "%"),
    #distk=paste0(round(mean(distk, na.rm = T), digits = 2), " (", round(sd(distk, na.rm = T), digits = 2), ")"),
    delays=paste0(round(mean(delays, na.rm = T), digits = 2), " (", round(sd(delays, na.rm = T), digits = 2), ")"),
    transp=paste0(round(mean(transp, na.rm = T)*100, digits = 2), "%"),
    occupancy=paste0(round(mean(occ_var, na.rm = T), digits = 2), " (", round(sd(occ_var, na.rm = T), digits = 2), ")"),
    slack_perc2=paste0(round(mean(slack_perc2, na.rm = T), digits = 2), " (", round(sd(slack_perc2, na.rm = T), digits = 2), ")"),
    slack2=paste0(round(mean(slack2, na.rm = T), digits = 2), " (", round(sd(slack2, na.rm = T), digits = 2), ")"),
    turnos=paste0(round(mean(turnos, na.rm = T), digits = 2), " (", round(sd(turnos, na.rm = T), digits = 2), ")"),
  )

LI_todos2 <- 
  Logit_INGRESOS %>%
  group_by(CAPACNUM, tipo_imae2) %>% 
  summarise(
    medimae=mean(medimae, na.rm = T),
    distk=mean(distk, na.rm = T),
            ) %>% 
  ungroup() %>%
  group_by(tipo_imae2) %>% 
  summarise(
    medimae=paste0(round(mean(medimae, na.rm = T)*100, digits = 2), "%"),
    distk=paste0(round(mean(distk, na.rm = T), digits = 2), " (", round(sd(distk, na.rm = T), digits = 2), ")"),
  )

LI_todos <- full_join(LI_todos1, LI_todos2, by="tipo_imae2") %>% 
  rename("Nephrologist"=medimae,
         "Distance (km)"=distk,
         "Delays (days)"=delays,
         "Occupancy (#)"=occupancy,
         "Slack (%)"=slack_perc2,
         "Slack(#)"=slack2,
         "Shifts"=turnos,
         "Transport"=transp) %>% 
  pivot_longer(cols=c(everything(), -tipo_imae2), names_to = "Indicator", values_to = "Value") %>% 
  pivot_wider(values_from="Value", names_from = "tipo_imae2") %>% 
  select(-"NA")

LI <- full_join(LI_choice, LI_todos, join_by("Indicator"))

summary(Logit_INGRESOS$dist)

print(xtable::xtable(LI_todos, file="patientdecision.tex"))
```


# 13. CALIDAD QUALITY

```{r}
my.max <- function(x) ifelse( !all(is.na(x)), max(x, na.rm=T), NA)

MENSUALES_HD <- read_sav("~/Proyecto Tesis/Databases/MENSUALES HD.sav")

#SESIONES_HD <- read_sav("~/Proyecto Tesis/Databases/SESIONES HD.sav")

PACIENTES <- 
  read_sav("C:/Users/julie/OneDrive/Documentos/Proyecto Tesis/Databases/PACIENTES.sav") %>% 
  select(CAPACNUM, PAC_SEXO, PAC_FEC_NAC)

GEO <- read_csv("GEO.csv")

dist <- GEO %>% 
  filter(!is.na(dist18))  %>% # FILTRO PROVISORIO SACANDO PACIENTES CON DIST NA (60 OBS)
  select(CAPACNUM, starts_with("dist")) %>% 
  pivot_longer(cols = starts_with("dist"), names_to = "names", values_to = "dist") %>% 
  separate(col = names, into = c("borrar", "id"), sep = "t") %>% select(-borrar) %>% 
  mutate(id=as.double(id)) %>% 
  left_join(IMAE_num, by="id") %>% select(-ZCAIMAE) %>% 
  filter(depto=="01") %>% mutate(num_choice=as.double(num_choice))

INGRESOS_HD <- INGRESOS_HD %>% select(CAPACNUM, tipo_inst, B1SNIVEL, CASEDADA, 
                                      AAFAVTI, AAFAVTO, AACATP, AACATT, AAPRIMHD,
                                      descom, coord)

dife_peso <- SESIONES_HD %>% 
  mutate(DPESOSE=case_when(DPESOSE==999.00 ~ NA,
                           .default = as.numeric(DPESOSE)),
         DPESOPO=case_when(DPESOPO==999.00 ~ NA,
                           .default = as.numeric(DPESOPO)),
         dife=DPESOPO-DPESOSE) %>% 
  group_by(PMD_ANIO, PMD_MES, CAPACNUM) %>% 
  summarize(dife=mean(dife, na.rm=T)) %>% 
  mutate(peso=case_when(abs(dife)<=0.5 ~ 1,
                        abs(dife)>0.5 ~ 0,
                        is.na(dife) ~ NA))

MENSUALES_HD2 <- MENSUALES_HD %>% 
  right_join(INGRESOS_HD, by="CAPACNUM") %>% 
  left_join(PACIENTES, by="CAPACNUM") %>%
  #left_join(dist, by=c("CAPACNUM", "PMD_IMAE"="num_choice")) %>%
  #left_join(dife_peso, by=c("PMD_ANIO", "PMD_MES", "CAPACNUM")) %>% 
  select(CAPACNUM, ZPMD_IMAE, DDIAB, DCISQ, DEVP, PMD_ANIO, DTRABA, DFUMA, PMD_CANTBICA, 
         PMD_ANIO, PMD_MES, tipo_inst, PAC_SEXO, CASEDADA, 
         ESAZOPR1, ESAZOPO1, ESAZOPR2, EMAZOEM, ESFOSF, EMHEMOG, ZPMD_ESTADO, 
         COMP, COMP1, COMP2, COMP3, ESKTV,
         descom, coord, 
         PMD_IMAE,
         #peso,
         #dist, depto,
         PAC_FEC_NAC, fecha_solicitud, fecha_autorizacion) %>% 
  rename(ZCAIMAE=ZPMD_IMAE) %>% 
  unite("mes_mensual", c(PMD_ANIO,PMD_MES), sep="-", remove=FALSE) %>% 
  mutate(fecha_mensual = as.Date(paste(mes_mensual, "-01", sep=""))) %>% 
  filter(ZCAIMAE!="SENNIAD HEMO",
         ZCAIMAE!="IMAE A CONFIRMAR") %>% 
  mutate(
    edad = as.numeric(difftime(fecha_mensual, PAC_FEC_NAC, 
                                    units = "days") / 365.25),
    ZCAIMAE=if_else(ZCAIMAE=="HOSPITAL ITALIANO", "UNIVERSAL", ZCAIMAE),
    #Date = as.Date(paste(fecha, "-01", sep="")),
    #mes=format(Date, "%Y-%m"),
    DDIAB=case_when(
      DDIAB=="S" ~ 1,
      DDIAB=="N" ~ 0,
      DDIAB=="D" ~ as.numeric(NA),
      .default = as.numeric(NA)),
    DCISQ=case_when(
      DCISQ=="S" ~ 1,
      DCISQ=="N" ~ 0,
      DCISQ=="D" ~ as.numeric(NA),
      .default = as.numeric(NA)),
    DEVP=case_when(
      DEVP=="S" ~ 1,
      DEVP=="N" ~ 0,
      DEVP=="D" ~ as.numeric(NA),
      .default = as.numeric(NA)),
    DTRABA=case_when(
      DTRABA=="S" ~ 1,
      DTRABA=="N" ~ 0,
      DTRABA=="D" ~ as.numeric(NA),
      .default = as.numeric(NA)),
    DFUMA=case_when(
      DFUMA=="S" ~ 1,
      DFUMA=="N" ~ 0,
      DFUMA=="D" ~ as.numeric(NA),
      .default = as.numeric(NA)),
    ASSE=case_when(
      tipo_inst=="ASSE" ~ 1,
      .default = 0),
    IAMC_IAMPP=case_when(
      tipo_inst=="IAMC/IAMPP" ~ 1,
      .default = 0),
    CORPORATIVO=case_when(
      tipo_inst=="CORPORATIVO" ~ 1,
      .default = 0),
    PRIVADO=case_when(
      tipo_inst=="SEGURO PRIVADO" ~ 1,
      .default = 0),
    mujer=case_when(
      PAC_SEXO=="F" ~ 1,
      .default = 0),
    descom=case_when(
      descom=="S" ~ 1,
      descom=="N" ~ 0,
      descom=="D" ~ 0),
    coord=case_when(
      coord=="S" ~ 1,
      coord=="N" ~ 0,
      .default = 0),
    URR=if_else(!is.na(ESAZOPR1), 
                (ESAZOPR1-ESAZOPO1)/ESAZOPR1,
                (ESAZOPR2-ESAZOPO1)/ESAZOPR2),
    URR65=case_when(URR>=0.65 ~ 1,
                    URR<0.65 ~ 0),
    urea17=case_when(EMAZOEM<1.7 ~ 1,
                     EMAZOEM>=1.7 ~ 0),
    fosf55=case_when(ESFOSF<5.5 ~ 1,
                     ESFOSF>=5.5 ~ 0),
    hemo10=case_when(EMHEMOG>=10 ~ 1,
                     EMHEMOG<10 ~ 0),
    surv=case_when(ZPMD_ESTADO!="FALLECIMIENTO" ~ 1,
                   ZPMD_ESTADO=="FALLECIMIENTO" ~ 0),
    comp=case_when(COMP=="S" ~ 0,
                   COMP=="N" ~ 1,
                   COMP=="D" | COMP=="D" | COMP==NA ~ NA),
    sept=case_when(COMP1 %in% c(184010162, 184010183, 184010159, 184010160, 184010161) |
                     COMP2 %in% c(184010162, 184010183, 184010159, 184010160, 184010161) |
                     COMP3 %in% c(184010162, 184010183, 184010159, 184010160, 184010161) ~ 0,
                   COMP=="N" ~ 1,
                   COMP=="D" | COMP=="D" | COMP==NA ~ NA),
    ktv12=case_when(ESKTV>=1.2 ~ 1,
                         ESKTV<1.2 ~ 0)
  ) %>%
  group_by(CAPACNUM, PMD_ANIO) %>% 
  mutate(
    DDIAB=my.max(DDIAB),
    DCISQ=my.max(DCISQ),
    DEVP=my.max(DEVP),
    DTRABA=my.max(DTRABA),
    DFUMA=my.max(DFUMA),
  ) %>%
  ungroup() %>% 
  group_by(CAPACNUM) %>% 
  arrange(PMD_ANIO, PMD_MES) %>% 
  mutate(meses=row_number())

# Reorder "anio" in increasing order
MENSUALES_HD2$anio <- factor(MENSUALES_HD2$PMD_ANIO, levels = sort(unique(MENSUALES_HD2$PMD_ANIO)))

# Reorder "ZCAIMAE" alphabetically
MENSUALES_HD2$ZCAIMAE <- factor(MENSUALES_HD2$ZCAIMAE, levels = sort(unique(MENSUALES_HD2$ZCAIMAE)))

# Set reference levels for anio, ZCAIMAE and CAPACNUM
MENSUALES_HD2$anio <- relevel(MENSUALES_HD2$anio, ref = "2004")
MENSUALES_HD2$ZCAIMAE <- relevel(MENSUALES_HD2$ZCAIMAE, ref = "ASOCIACION ESPAÑOLA")
MENSUALES_HD2$CAPACNUM <- relevel(as.factor(MENSUALES_HD2$CAPACNUM), ref="344677")

m_URR <- lm(URR65 ~ - 1 + 
               CASEDADA + meses + PMD_CANTBICA + descom +
               mujer + 
               DDIAB + DCISQ + DEVP + DTRABA + DFUMA +
               IAMC_IAMPP + PRIVADO + CORPORATIVO +
               ZCAIMAE:anio, 
             data=MENSUALES_HD2)

m_urea <- lm(urea17 ~ - 1 + 
               CASEDADA + meses + PMD_CANTBICA + descom +
               mujer + 
               DDIAB + DCISQ + DEVP + DTRABA + DFUMA +
               IAMC_IAMPP + PRIVADO + CORPORATIVO +
               ZCAIMAE:anio, 
             data=MENSUALES_HD2)

m_fosf <- lm(fosf55 ~ - 1 + 
               CASEDADA + meses + PMD_CANTBICA + descom +
               mujer + 
               DDIAB + DCISQ + DEVP + DTRABA + DFUMA +
               IAMC_IAMPP + PRIVADO + CORPORATIVO +
               ZCAIMAE:anio, 
             data=MENSUALES_HD2)

m_hemo <- lm(hemo10 ~ - 1 + 
               CASEDADA + meses + PMD_CANTBICA + descom +
               mujer + 
               DDIAB + DCISQ + DEVP + DTRABA + DFUMA +
               IAMC_IAMPP + PRIVADO + CORPORATIVO +
               ZCAIMAE:anio, 
             data=MENSUALES_HD2)

m_surv <- lm(surv ~ - 1 + 
               CASEDADA + meses + PMD_CANTBICA + descom +
               mujer + 
               DDIAB + DCISQ + DEVP + DTRABA + DFUMA +
               IAMC_IAMPP + PRIVADO + CORPORATIVO +
               ZCAIMAE:anio, 
             data=MENSUALES_HD2)

m_comp <- lm(comp ~ - 1 + 
               CASEDADA + meses + PMD_CANTBICA + descom +
               mujer + 
               DDIAB + DCISQ + DEVP + DTRABA + DFUMA +
               IAMC_IAMPP + PRIVADO + CORPORATIVO +
               ZCAIMAE:anio, 
             data=MENSUALES_HD2)

m_sept <- lm(sept ~ - 1 + 
               CASEDADA + meses + PMD_CANTBICA + descom +
               mujer + 
               DDIAB + DCISQ + DEVP + DTRABA + DFUMA +
               IAMC_IAMPP + PRIVADO + CORPORATIVO +
               ZCAIMAE:anio, 
             data=MENSUALES_HD2)

m_ktv <- lm(ktv12 ~ - 1 + 
               CASEDADA + meses + PMD_CANTBICA + descom +
               mujer + 
               DDIAB + DCISQ + DEVP + DTRABA + DFUMA +
               IAMC_IAMPP + PRIVADO + CORPORATIVO +
               ZCAIMAE:anio, 
             data=MENSUALES_HD2)

get_all_predictions <- function(model, data) {
  # Create a data frame with all combinations of "IMAE" and "anio"
  data
  combinations <- expand.grid(
    IMAE = levels(data$ZCAIMAE),  
    anio = levels(data$anio)      
  )
  
  # Convert "IMAE" and "anio" to factors
  combinations$IMAE <- as.factor(combinations$IMAE)
  combinations$anio <- as.factor(combinations$anio)
  
  # Create a data frame with mean values for other predictors
  mean_values <- data.frame(
    CASEDADA = mean(data$CASEDADA, na.rm = TRUE),
    meses = mean(data$meses, na.rm = TRUE),
    mujer = mean(data$mujer, na.rm = TRUE),
    DDIAB = mean(data$DDIAB, na.rm = TRUE),
    DCISQ = mean(data$DCISQ, na.rm = TRUE),
    DEVP = mean(data$DEVP, na.rm = TRUE),
    IAMC_IAMPP = mean(data$IAMC_IAMPP, na.rm = TRUE),
    PRIVADO = mean(data$PRIVADO, na.rm = TRUE),
    CORPORATIVO = mean(data$CORPORATIVO, na.rm = TRUE),
    DTRABA = mean(data$DTRABA, na.rm = TRUE),
    DFUMA = mean(data$DFUMA, na.rm = TRUE),
    PMD_CANTBICA = mean(data$PMD_CANTBICA, na.rm = TRUE),
    descom = mean(data$descom, na.rm = TRUE)
    )
  
  # Initialize an empty data frame to store predictions
  all_predictions <- data.frame()
  
  # Loop through all combinations and get predictions
  for (i in 1:nrow(combinations)) {
    mean_values$ZCAIMAE <- combinations$IMAE[i]
    mean_values$anio <- combinations$anio[i]
    predictions <- predict(model, newdata = mean_values)
    
    # Check if the coefficient for ZCAIMAE:anio is NA, and set predictions to NA accordingly
    if (is.na(coef(model)[paste0("ZCAIMAE", combinations$IMAE[i], ":anio", combinations$anio[i])])) {
      predictions <- NA
    }
    
    result <- data.frame(IMAE = combinations$IMAE[i], anio = combinations$anio[i], Prediction = predictions)
    all_predictions <- rbind(all_predictions, result)
  }
  
  return(all_predictions)
}

INGRESOS_HD2 <- read_csv("C:/Users/julie/OneDrive/Documentos/Proyecto Tesis/MastersThesis/INGRESOS_HD2.csv")

tipo_imae <- INGRESOS_HD2 %>% ungroup() %>% select("ZCAIMAE", "tipo_choice") %>% unique()
IMAE_num <- read_csv("C:/Users/julie/OneDrive/Documentos/Proyecto Tesis/MastersThesis/IMAE_num.csv") %>% filter(ZCAIMAE!="HOSPITAL ITALIANO")

pred_urea <- get_all_predictions(m_urea, MENSUALES_HD2) %>% rename(urea=Prediction)
pred_surv <- get_all_predictions(m_surv, MENSUALES_HD2) %>% rename(surv=Prediction)
pred_fosf <- get_all_predictions(m_fosf, MENSUALES_HD2) %>% rename(fosf=Prediction)
pred_hemo <- get_all_predictions(m_hemo, MENSUALES_HD2) %>% rename(hemo=Prediction)
pred_comp <- get_all_predictions(m_comp, MENSUALES_HD2) %>% rename(comp=Prediction)
pred_sept <- get_all_predictions(m_sept, MENSUALES_HD2) %>% rename(sept=Prediction)
#pred_peso <- get_all_predictions(m_peso, base) %>% rename(peso=Prediction)
pred_URR <- get_all_predictions(m_URR, MENSUALES_HD2) %>% rename(URR=Prediction)
pred_ktv <- get_all_predictions(m_ktv, MENSUALES_HD2) %>% rename(ktv=Prediction)
#pred_comp_dialisis <- get_all_predictions(m_comp_dialisis, base) %>% rename(comp_dialisis=Prediction)

quality <- left_join(pred_URR, pred_surv, by=c("IMAE", "anio")) %>% 
  #left_join(pred_fosf, by=c("IMAE", "anio")) %>%
  left_join(pred_hemo, by=c("IMAE", "anio")) %>%
  left_join(pred_comp, by=c("IMAE", "anio")) %>%
  left_join(pred_sept, by=c("IMAE", "anio")) %>%
  #left_join(pred_peso, by=c("IMAE", "anio")) %>%
  left_join(pred_urea, by=c("IMAE", "anio")) %>%
  left_join(pred_ktv, by=c("IMAE", "anio")) %>% 
  #left_join(pred_comp_dialisis, by=c("IMAE", "anio")) %>%
  left_join(tipo_imae, by=c("IMAE"="ZCAIMAE")) %>%
  mutate(tipo_imae2=case_when(tipo_choice=="INDEPENDIENTE" ~ "Indep",
                              tipo_choice=="PRIVADO" ~ "Priv Ins",
                              tipo_choice=="PUBLICO" ~ "Pub Ins")) %>% 
  left_join(IMAE_num, by=c("IMAE"="ZCAIMAE")) %>% 
  rename(ZCAIMAE=IMAE) %>% mutate(anio=as.double(as.character(anio))) %>% 
  select(-c(choice))
  

write.csv(
  quality,
  "C:/Users/julie/OneDrive/Documentos/Proyecto Tesis/MastersThesis/quality.csv", 
  row.names=FALSE)


non_adj_quality <- MENSUALES_HD2 %>% 
  group_by(ZCAIMAE, anio) %>% 
  summarise(urea=mean(urea17, na.rm = T),
            surv=mean(surv, na.rm = T),
            fosf=mean(fosf55, na.rm = T),
            hemo=mean(hemo10, na.rm = T),
            #peso=mean(peso, na.rm = T),
            comp=mean(comp, na.rm = T),
            URR=mean(URR65, na.rm = T),
            ktv=mean(ktv12, na.rm = T),
            sept=mean(sept, na.rm = T)) %>%
  rename(IMAE=ZCAIMAE) %>% 
  left_join(tipo_imae, by=c("IMAE"="ZCAIMAE")) %>%
  mutate(tipo_imae2=case_when(tipo_choice=="INDEPENDIENTE" ~ "Indep",
                                tipo_choice=="PRIVADO" ~ "Priv Ins",
                                tipo_choice=="PUBLICO" ~ "Pub Ins")) %>% 
    left_join(IMAE_num, by=c("IMAE"="ZCAIMAE"))


adjusted <- quality %>%
  pivot_longer(cols = c("urea", "surv", "hemo", "comp", 
                        "sept", "URR", "ktv"), 
               names_to = "measure", values_to = "value") %>% 
  group_by(measure) %>% 
  summarise(Mean = round(mean(value, na.rm = TRUE), 2), 
            "Std Dev" = paste0("(", round(sd(value, na.rm = TRUE), 2), ")")) %>% 
  as.data.frame()

unadjusted <- non_adj_quality %>%
  pivot_longer(cols = c("urea", "surv", "hemo", 
                        "comp", "sept",  "URR", "ktv"), 
               names_to = "measure", values_to = "value") %>% 
  group_by(measure) %>% 
  summarise(Mean = round(mean(value, na.rm = TRUE), 2), 
            "Std Dev" = paste0("(", round(sd(value, na.rm = TRUE), 2), ")"))

labs <- c("Urea", "Survival", "Hemoglobin", 
          "No complications", "Septic infection", 
          "Urea Reduction Rate", "Kt/V")
names(labs) <- c("urea", "surv", "hemo", "comp", "sept", "URR", "ktv")

names <- cbind(names(labs), labs)%>% as.data.frame()
colnames(names) <- c("measure", "Names") 

mean_sd <- unadjusted %>% full_join(adjusted, by="measure") %>% 
  full_join(names, by="measure") %>%
  select(Names, everything(), -measure)

print(xtable::xtable(mean_sd, caption = "Means and Standard Deviations of Variables"), 
      caption.placement = "top", include.rownames = FALSE, file="table.tex")

quality %>%
  filter(depto=="01",
         ZCAIMAE!="SENNIAD HEMO") %>% 
  pivot_longer(c(urea, surv, hemo, comp, sept, URR, ktv)) %>% 
  ggplot(aes(y=value, x=tipo_imae2, color=tipo_imae2)) +
  geom_boxplot() +
  facet_wrap(~name, scale="free_y", labeller = labeller(name=labs)) +
  coord_cartesian(ylim = c(0, 1)) +  # Restrict y-axis from 0 to 1
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),  # Remove x-axis label
    axis.title.y = element_blank(),  # Remove x-axis label
    panel.background = element_rect(fill = "white"),  # Change background to white
    panel.grid.major = element_line(color = "gray"),  # Change major gridlines to gray
    panel.grid.minor = element_blank(),  # Remove minor gridlines
    strip.background = element_blank()  # Remove background from facet titles
  ) +
  scale_color_viridis_d(end=0.8)
#ggsave("adjusted.png", dpi = 500, wid)

non_adj_quality %>%
    filter(depto=="01",
         IMAE!="SENNIAD HEMO") %>% 
  pivot_longer(c(urea, surv, hemo, comp, sept, URR, ktv)) %>% 
  ggplot(aes(y=value, x=tipo_imae2, color=tipo_imae2)) +
  geom_boxplot() +
  facet_wrap(~name, scale="free_y", labeller = labeller(name=labs)) +
  coord_cartesian(ylim = c(0, 1)) +  # Restrict y-axis from 0 to 1
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),  # Remove x-axis label
    axis.title.y = element_blank(),  # Remove x-axis label
    panel.background = element_rect(fill = "white"),  # Change background to white
    panel.grid.major = element_line(color = "gray"),  # Change major gridlines to gray
    panel.grid.minor = element_blank(),  # Remove minor gridlines
    strip.background = element_blank()  # Remove background from facet titles
  ) +
  scale_color_viridis_d(end=0.8)
#ggsave("unadjusted.png", dpi = 500, scale=3)

library(stargazer)
stargazer(m_urea, m_hemo, m_surv, m_comp, m_sept, m_ktv, m_URR,
          type="latex",
          keep = c("CASEDADA", "meses", "PMD_CANTBICA", "descom", "mujer",
                   "DDIAB", "DCISQ", "DEVP", "DTRABA", "DFUMA",
                   "IAMC_IAMPP", "PRIVADO", "CORPORATIVO"), 
          df=FALSE, omit.stat = c("ser","f", "rsq"), no.space = TRUE,
          report = "vc*",
          dep.var.labels = c("Urea", "Hemoglobin", "Survival", 
                             "Complications", "Infections", "Kt/V", "URR"),
          covariate.labels = c("Age", "Months on dialysis", "Monthly sessions", "Decompensated at start", 
                               "Female", "Diabetic",  "Cardiopathy", "Vascular perfipheral disease",
                               "Working", "Smoking",
                               "IAMC/IAMPP", "Private insurance", "Corporate insurance"),
          out="reg.tex",
          notes = "Dependent variables are dummies indicating adecuate levels of the measure.",
          notes.append = T,
          notes.align = "l")


mean_qual <- quality %>%
  filter(depto=="01",
         ZCAIMAE!="SENNIAD HEMO") %>% 
  rename(IMAE=ZCAIMAE) %>% 
  group_by(IMAE) %>% 
  summarise(URR = mean(URR, na.rm = TRUE),
            ktv = mean(ktv, na.rm = TRUE), 
            sept = mean(sept, na.rm = TRUE),
            surv = mean(surv, na.rm = TRUE),
            tipo_imae2 = first(tipo_imae2))


mean_non_adj_qual <- non_adj_quality %>%
  filter(depto=="01",
         IMAE!="SENNIAD HEMO") %>% 
  group_by(IMAE) %>% 
  summarise(URR = mean(URR, na.rm = TRUE),
            ktv = mean(ktv, na.rm = TRUE), 
            sept = mean(sept, na.rm = TRUE),
            surv = mean(surv, na.rm = TRUE),
            tipo_imae2 = first(tipo_imae2))


mean_qual %>% 
  ggplot(aes(y = URR, x = reorder(IMAE, -URR), fill = tipo_imae2)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  scale_fill_viridis_d(end = 0.8, name = "Provider type") +  # Adding legend title
  theme(
    legend.position = "bottom",
    axis.title.x = element_blank(),  # Remove x-axis label
    axis.title.y = element_blank(),  # Remove x-axis label
    panel.background = element_rect(fill = "white"),  # Change background to white
    panel.grid.major = element_line(color = "gray"),  # Change major gridlines to gray
    panel.grid.minor = element_blank(),  # Remove minor gridlines
    strip.background = element_blank()  # Remove background from facet titles
  ) +
  scale_x_discrete(labels = function(x) substr(x, nchar(x)-7, nchar(x))) +
  coord_cartesian(ylim = c(0, 1))
ggsave("mean_adjusted_URR.png", dpi = 500, scale=3)


mean_non_adj_qual %>% 
  ggplot(aes(y = URR, x = reorder(IMAE, -URR), fill = tipo_imae2)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  scale_fill_viridis_d(end = 0.8, name = "Provider type") +  # Adding legend title
  theme(
    legend.position = "bottom",
    axis.title.x = element_blank(),  # Remove x-axis label
    axis.title.y = element_blank(),  # Remove x-axis label
    panel.background = element_rect(fill = "white"),  # Change background to white
    panel.grid.major = element_line(color = "gray"),  # Change major gridlines to gray
    panel.grid.minor = element_blank(),  # Remove minor gridlines
    strip.background = element_blank()  # Remove background from facet titles
  ) +
  scale_x_discrete(labels = function(x) substr(x, nchar(x)-7, nchar(x))) +
  coord_cartesian(ylim = c(0, 1))
ggsave("mean_unadjusted_URR.png", dpi = 500, scale=3)



```


# 14. ¿Cuántas diálisis en el Clínicas 2023?

```{r}

HC <- SESIONES_HD %>% 
  filter(ZPMD_IMAE=="HOSPITAL DE CLINICAS") %>% 
  group_by(PMD_ANIO, PMD_MES) %>% 
  summarise(n=n())

summary(HC$n)

```


# Bendita descriptiva pacientes

```{r}
library(readr)

PACIENTES <- 
  read_sav("C:/Users/julie/OneDrive/Documentos/Proyecto Tesis/Databases/PACIENTES.sav")

my.max <- function(x) ifelse( !all(is.na(x)), max(x, na.rm=T), NA)
my.min <- function(x) ifelse( !all(is.na(x)), min(x, na.rm=T), NA)

MENSUALES_HD3 <- INGRESOS_HD %>% 
  right_join(MENSUALES_HD, by="CAPACNUM") %>% 
  left_join(PACIENTES, by="CAPACNUM") %>%
  #left_join(dife_peso, by=c("PMD_ANIO", "PMD_MES", "CAPACNUM")) %>% 
  select(CAPACNUM, ZPMD_IMAE, DDIAB, DCISQ, DEVP, PMD_ANIO, DTRABA, DFUMA, PMD_CANTBICA, 
         PMD_ANIO, PMD_MES, tipo_inst, PAC_SEXO, CASEDADA, 
         ESAZOPR1, ESAZOPO1, ESAZOPR2, EMAZOEM, ESFOSF, EMHEMOG, ZPMD_ESTADO, 
         COMP, COMP1, COMP2, COMP3, ESKTV,
         descom, coord, 
         #peso,
         PAC_FEC_NAC, fecha_solicitud, fecha_autorizacion,
         starts_with("edu"), jubi) %>% 
  rename(ZCAIMAE=ZPMD_IMAE) %>% 
  unite("mes_mensual", c(PMD_ANIO,PMD_MES), sep="-", remove=FALSE) %>% 
  mutate(fecha_mensual = as.Date(paste(mes_mensual, "-01", sep=""))) %>% 
  filter(ZCAIMAE!="SENNIAD HEMO",
         ZCAIMAE!="IMAE A CONFIRMAR") %>% 
  mutate(
    edad = as.numeric(difftime(fecha_mensual, PAC_FEC_NAC, 
                                    units = "days") / 365.25),
    ZCAIMAE=if_else(ZCAIMAE=="HOSPITAL ITALIANO", "UNIVERSAL", ZCAIMAE),
    #Date = as.Date(paste(fecha, "-01", sep="")),
    #mes=format(Date, "%Y-%m"),
    DDIAB=case_when(
      DDIAB=="S" ~ 1,
      DDIAB=="N" ~ 0,
      DDIAB=="D" ~ as.numeric(NA),
      .default = as.numeric(NA)),
    DCISQ=case_when(
      DCISQ=="S" ~ 1,
      DCISQ=="N" ~ 0,
      DCISQ=="D" ~ as.numeric(NA),
      .default = as.numeric(NA)),
    DEVP=case_when(
      DEVP=="S" ~ 1,
      DEVP=="N" ~ 0,
      DEVP=="D" ~ as.numeric(NA),
      .default = as.numeric(NA)),
    DTRABA=case_when(
      DTRABA=="S" ~ 1,
      DTRABA=="N" ~ 0,
      DTRABA=="D" ~ as.numeric(NA),
      .default = as.numeric(NA)),
    DFUMA=case_when(
      DFUMA=="S" ~ 1,
      DFUMA=="N" ~ 0,
      DFUMA=="D" ~ as.numeric(NA),
      .default = as.numeric(NA)),
    ASSE=case_when(
      tipo_inst=="ASSE" ~ 1,
      .default = 0),
    IAMC_IAMPP=case_when(
      tipo_inst=="IAMC/IAMPP" ~ 1,
      .default = 0),
    CORPORATIVO=case_when(
      tipo_inst=="CORPORATIVO" ~ 1,
      .default = 0),
    PRIVADO=case_when(
      tipo_inst=="SEGURO PRIVADO" ~ 1,
      .default = 0),
    mujer=case_when(
      PAC_SEXO=="F" ~ 1,
      .default = 0),
    descom=case_when(
      descom=="S" ~ 1,
      descom=="N" ~ 0,
      descom=="D" ~ 0),
    coord=case_when(
      coord=="S" ~ 1,
      coord=="N" ~ 0,
      .default = 0),
    URR=if_else(!is.na(ESAZOPR1), 
                (ESAZOPR1-ESAZOPO1)/ESAZOPR1,
                (ESAZOPR2-ESAZOPO1)/ESAZOPR2),
    URR65=case_when(URR>=0.65 ~ 1,
                    URR<0.65 ~ 0),
    urea17=case_when(EMAZOEM<1.7 ~ 1,
                     EMAZOEM>=1.7 ~ 0),
    fosf55=case_when(ESFOSF<5.5 ~ 1,
                     ESFOSF>=5.5 ~ 0),
    hemo10=case_when(EMHEMOG>=10 ~ 1,
                     EMHEMOG<10 ~ 0),
    surv=case_when(ZPMD_ESTADO!="FALLECIMIENTO" ~ 1,
                   ZPMD_ESTADO=="FALLECIMIENTO" ~ 0),
    comp=case_when(COMP=="S" ~ 0,
                   COMP=="N" ~ 1,
                   COMP=="D" | COMP=="D" | COMP==NA ~ NA),
    sept=case_when(COMP1 %in% c(184010162, 184010183, 184010159, 184010160, 184010161) |
                     COMP2 %in% c(184010162, 184010183, 184010159, 184010160, 184010161) |
                     COMP3 %in% c(184010162, 184010183, 184010159, 184010160, 184010161) ~ 0,
                   COMP=="N" ~ 1,
                   COMP=="D" | COMP=="D" | COMP==NA ~ NA),
    ktv12=case_when(ESKTV>=1.2 ~ 1,
                         ESKTV<1.2 ~ 0)
  ) %>%
  group_by(CAPACNUM, PMD_ANIO) %>% 
  mutate(
    DDIAB=my.max(DDIAB),
    DCISQ=my.max(DCISQ),
    DEVP=my.max(DEVP),
    DTRABA=my.max(DTRABA),
    DFUMA=my.max(DFUMA),
  ) %>%
  ungroup() %>% 
  group_by(CAPACNUM) %>% 
  arrange(PMD_ANIO, PMD_MES) %>% 
  mutate(meses=row_number()) 

IMAE_num <- read_csv("C:/Users/julie/OneDrive/Documentos/Proyecto Tesis/MastersThesis/IMAE_num.csv") 

IMAE_num <- IMAE_num %>%
  mutate(
  tipo_imae=
      case_when(ZCAIMAE %in% c(IMAE_CENEU, IMAE_NEPHROS, IMAE_DIAVERUM, IMAE_SARI) ~ "INDEPENDIENTE",
                ZCAIMAE %in% IMAE_PUBLICO ~ "PUBLICO",
                ZCAIMAE %in% IMAE_PRIVADO ~ "PRIVADO",
                TRUE ~ NA)
  )

imaes <- INGRESOS_HD %>% group_by(ZCAIMAE) %>% summarise(CAIMAE=first(CAIMAE))

pacientes <- MENSUALES_HD3 %>% 
  left_join(IMAE_num, by="ZCAIMAE") %>%
      filter(depto=="01", # Filter for facilities in Montevideo
         ZCAIMAE!="SENNIAD HEMO") %>% 
  mutate(dead=if_else(ZPMD_ESTADO=="FALLECIMIENTO", 1, 0)) %>% 
  group_by(CAPACNUM) %>% 
  summarize(
    dead = max(dead),
    edad_min = my.min(edad),
    edad_max = my.max(edad),
    meses = max(meses, na.rm = TRUE),
    PMD_CANTBICA = mean(PMD_CANTBICA, na.rm = TRUE),
    mujer = first(mujer, na.rm = TRUE),
    ASSE = first(ASSE, na.rm = TRUE),
    IAMC_IAMPP = mean(IAMC_IAMPP, na.rm = TRUE),
    CORPORATIVO = mean(CORPORATIVO, na.rm = TRUE),
    DDIAB = mean(DDIAB, na.rm = TRUE),
    DCISQ = mean(DCISQ, na.rm = TRUE),
    DEVP = mean(DEVP, na.rm = TRUE),
    DTRABA = mean(DTRABA, na.rm = TRUE),
    DFUMA = mean(DFUMA, na.rm = TRUE),
    descom = mean(descom, na.rm = TRUE),
    edu_ningu = mean(edu_ningu, na.rm = TRUE),
    edu_prim_or_less = mean(edu_prim_or_less, na.rm = TRUE),
    edu_sec_or_more = mean(edu_sec_or_more, na.rm = TRUE),
    edu_utu = mean(edu_utu, na.rm = TRUE),
    edu_uni = mean(edu_uni, na.rm = TRUE),
    jubi = mean(jubi, na.rm = TRUE),
    tipo_imae=first(tipo_imae)
  ) 

tabla_pacientes <- pacientes %>% 
  group_by(tipo_imae) %>% 
  summarize(
    "# patients" = paste0(round(n_distinct(CAPACNUM), 2)),
    "Age at start" = paste0(round(mean(edad_min, na.rm = TRUE), 2)),
    "Age at start | Dead" = paste0(round(mean(edad_min[dead==1], na.rm = TRUE), 2)),
    "Age at death" = paste0(round(mean(edad_max[dead==1], na.rm = TRUE), 2)),
    "Months on dialysis" = paste0(round(mean(meses, na.rm = TRUE), 2)),
    "Months on dialysis | Dead" = paste0(round(mean(meses[dead==1], na.rm = TRUE), 2)),
    "Monthly sessions" = paste0(round(mean(PMD_CANTBICA, na.rm = TRUE), 2)),
    Female = paste0(round(mean(mujer, na.rm = TRUE)*100, 2), "%"),
    ASSE = paste0(round(mean(ASSE, na.rm = TRUE)*100, 2), "%"),
    IAMC_IAMPP = paste0(round(mean(IAMC_IAMPP, na.rm = TRUE)*100, 2), "%"),
    "Primary or less" = paste0(round(mean(edu_prim_or_less, na.rm = TRUE)*100, 2), "%"),
    "Secondary or more" = paste0(round(mean(edu_sec_or_more, na.rm = TRUE)*100, 2), "%"),
    Retired = paste0(round(mean(jubi, na.rm = TRUE)*100, 2), "%"),
    Diabetic = paste0(round(mean(DDIAB, na.rm = TRUE)*100, 2), "%"),
    Cardiopathy = paste0(round(mean(DCISQ, na.rm = TRUE)*100, 2), "%"),
    Smoking = paste0(round(mean(DFUMA, na.rm = TRUE)*100, 2), "%"),
    "Decompensated start" = paste0(round(mean(descom, na.rm = TRUE)*100, 2), "%"),
  ) %>% 
  pivot_longer(cols=c(everything(), -tipo_imae), names_to = "Indicator", values_to = "Value") %>% 
  pivot_wider(values_from="Value", names_from = "tipo_imae") %>% 
  mutate_if(is.numeric, round, digits=2) %>% 
  rename(
    "Public ins" = PUBLICO,
    "Private ins" = PRIVADO,
    "Independent" = INDEPENDIENTE
  )

print(xtable::xtable(tabla_pacientes, file="tabla_pacientes.tex",
                     align = c("l", "l", "c", "c", "c"),
                     caption = "Patients entering dialysis 2003-2017 in Montevideo"), include.rownames=FALSE)


```


# 18. Edad en INGRESOS_HD (muchos missings) vs fecha de nacimiento en PACIENTES_HD

```{r}
PACIENTES <- 
  read_sav("C:/Users/julie/OneDrive/Documentos/Proyecto Tesis/Databases/PACIENTES.sav")

comparar <- MENSUALES_HD %>%
  left_join(INGRESOS_HD, by="CAPACNUM") %>% 
  left_join(PACIENTES, by="CAPACNUM") %>% 
  select(CASEDADA, PAC_FEC_NAC, fecha_solicitud)

summary(comparar$CASEDADA)
```

# Quiénes están en MENSUALES, quiénes en INGRESOS, quienes en los dos

```{r}

mens <- MENSUALES_HD %>% mutate(mens=1) %>% select(CAPACNUM, mens, PMD_ANIO)
ingr <- INGRESOS_HD %>% mutate(ingr=1) %>% select(CAPACNUM, ingr, anio_solicitud)

ambos <- left_join(mens, ingr, by="CAPACNUM") %>% 
  mutate(mens=if_else(is.na(mens), 0, mens),
         ingr=if_else(is.na(ingr), 0, ingr),
         ambos=if_else(mens==1 & ingr==1, 1, 0),
         tipo=case_when(mens==1 & ingr==1 ~ "ambos",
                        mens==1 & ingr==0 ~ "mens",
                        mens==0 & ingr==1 ~ "ingr"))



anios <- ambos %>% group_by(anio_solicitud) %>% 
  summarise(ambos=mean(ambos, na.rm=T))

summ <- ambos %>% 
  group_by(CAPACNUM) %>% 
  summarise(months=n(),
            tipo=first(tipo)) %>% 
  group_by(tipo) %>% 
  summarise(months=mean(months))

summary(ambos)

```


# Variable de habilitados hecha "a mano" y variable de ocupación mirando pacientes en MENSUALES con origen en el centro

```{r}
library(haven)
MENSUALES_HD <- read_sav("~/Proyecto Tesis/Databases/MENSUALES HD.sav")

pacientes_mensuales <- MENSUALES_HD %>% 
  unite("fecha2", PMD_ANIO:PMD_MES, sep="-") %>% 
  mutate(fecha3=as.Date(paste(fecha2, "-01", sep=""))) %>% 
  filter(PMD_ORIG=="Del centro") %>% 
  rename(CAIMAE=PMD_IMAE) %>% 
  group_by(CAIMAE, fecha3) %>% summarize(n_capacnum=n_distinct(CAPACNUM))

capacity <- INFORMES_IMAES_HD %>% 
  mutate(fecha3=as.Date(paste(fecha2, "-01", sep=""))) %>% 
  select(CAIMAE, CAHMSPBN, CAHMSPBP, fecha3, DNLUT, DNMAT)

pacmens_capacity <- pacientes_mensuales %>% 
  left_join(capacity, by=c("fecha3", "CAIMAE")) %>% 
  mutate(habilitados=CAHMSPBN*(DNLUT+DNMAT),
         slack_hab=habilitados-n_capacnum,
         slack_CAH=CAHMSPBN-n_capacnum,
         habilitados_def=if_else(abs(slack_hab)<abs(slack_CAH),
                                 habilitados, CAHMSPBN),
         slack_def=habilitados_def-n_capacnum,
         mes_solicitud=format(fecha3, "%Y-%m"),
         ID_CAIMAE=as.character(CAIMAE)) %>% 
  ungroup() %>% 
  select(ID_CAIMAE, mes_solicitud, habilitados_def, slack_def, n_capacnum)

```


# Margen intensivo

```{r}
library(haven)
MENSUALES_HD <- read_sav("~/Proyecto Tesis/Databases/MENSUALES HD.sav")

imaes <- imaes %>% 
  rename(ID_CAIMAE=num_choice)

pacientes_mensuales <- MENSUALES_HD %>% 
  unite("fecha2", PMD_ANIO:PMD_MES, sep="-", remove=F) %>% 
  mutate(fecha3=as.Date(paste(fecha2, "-01", sep=""))) %>% 
  filter(PMD_ORIG=="Del centro") %>% 
  rename(CAIMAE=PMD_IMAE) %>% 
  group_by(CAIMAE, fecha3) %>% 
  summarize(n_capacnum=n_distinct(CAPACNUM)) %>% 
  group_by(CAIMAE) %>% 
  arrange(fecha3) %>%
  mutate(moving_avg_n = rollmean(n_capacnum, k = 12, fill = "extend", align = "center")) %>% 
  ungroup() %>% 
  mutate(
         dif=n_capacnum-moving_avg_n,
         dif_prop=dif/moving_avg_n) %>% 
  rename(pac_var=dif,
         pac_var_prop=dif_prop)

capacity <- INFORMES_IMAES_HD %>% 
  mutate(fecha3=as.Date(paste(fecha2, "-01", sep=""))) %>% 
  select(CAIMAE, CAHMSPBN, CAHMSPBP, fecha3, DNLUT, DNMAT)

pacmens_capacity <- pacientes_mensuales %>% 
  left_join(capacity, by=c("fecha3", "CAIMAE")) %>% 
  left_join(imaes, by=c("CAIMAE")) %>% 
    filter(depto=="01",
         ZCAIMAE!="SENNIAD HEMO") %>% 
  mutate(habilitados=CAHMSPBN*(DNLUT+DNMAT),
         slack_hab=habilitados-n_capacnum,
         slack_CAH=CAHMSPBN-n_capacnum,
         habilitados_def=if_else(abs(slack_hab)<abs(slack_CAH),
                                 habilitados, CAHMSPBN),
         slack_def=habilitados_def-n_capacnum,
         mes_solicitud=format(fecha3, "%Y-%m"),
         ID_CAIMAE=as.character(CAIMAE))  %>%
  mutate(tipo_imae2=case_when(tipo_imae=="INDEPENDIENTE" ~ "Indep",
                                tipo_imae=="PRIVADO" ~ "Priv Ins",
                                tipo_imae=="PUBLICO" ~ "Pub Ins"),
         tipo_imae3=case_when(tipo_imae2!="Pub Ins" ~ tipo_imae2,
                              ZCAIMAE=="HOSPITAL DE CLINICAS" ~ "Clinicas",
                              ZCAIMAE=="HOSPITAL MACIEL" ~ "Maciel")) %>% 
  ungroup() %>% 
  select(ID_CAIMAE, mes_solicitud, habilitados_def, slack_def, n_capacnum, pac_var, pac_var_prop,
         tipo_imae3, tipo_imae2, fecha3, depto, ZCAIMAE)

pacmens_capacity %>% 
  filter(depto=="01",
         ZCAIMAE!="SENNIAD HEMO",
         n_capacnum>1) %>% 
  group_by(tipo_imae3, fecha3) %>% 
  summarize(Patients=mean(n_capacnum, na.rm = T),
            Stations=mean(habilitados_def, na.rm = T)) %>% 
  pivot_longer(cols=c("Patients", "Stations"), values_to = "values", names_to = "Indicator") %>% 
ggplot(aes(x=fecha3, y=values, color=Indicator)) + geom_line() + facet_wrap( ~ tipo_imae3, nrow=2) + 
  theme(
        legend.position = "bottom",
    axis.title.x = element_blank(),  # Remove x-axis label
    panel.grid.minor = element_blank(),  # Remove minor gridlines
    strip.background = element_blank()  # Remove background from facet titles
  ) +
  scale_color_viridis_d(begin=0.5, end=0.8) + 
  labs(y="Average monthly count") 
ggsave("C:/Users/julie/OneDrive/Documentos/Proyecto Tesis/MastersThesis/Fleitas_Abril/patients_stations.png", dpi = 2000)

pacmens_capacity %>% 
  filter(depto=="01",
         ZCAIMAE!="SENNIAD HEMO",
         n_capacnum>1) %>% 
  group_by(tipo_imae2, fecha3) %>% 
  summarize(n_capacnum=mean(n_capacnum, na.rm = T),
            habilitados_def=mean(habilitados_def, na.rm = T)) %>% 
  pivot_longer(cols=c("habilitados_def", "n_capacnum"), values_to = "values", names_to = "indicator") %>% 
ggplot(aes(x=fecha3, y=values, color=indicator)) + geom_line() + facet_wrap( ~ tipo_imae2)


```


# 11. How many patients change facility? - MONTHLY

```{r}

IMAE_ingreso <- INGRESOS_HD %>% rename(IMAE_ingreso=ZCAIMAE)


# Todos ----
cambios_todos <- MENSUALES_HD %>%
  #filter(PMD_ORIG=="Del centro") %>% 
  mutate(
  ZPMD_IMAE=if_else(ZPMD_IMAE=="HOSPITAL ITALIANO", "UNIVERSAL", ZPMD_IMAE),
  ZPMD_IMAE=if_else(ZPMD_IMAE=="IMPASA", "SMI - SERVICIO MEDICO INTEGRAL", ZPMD_IMAE),
  ) %>% 
  right_join(IMAE_ingreso, by="CAPACNUM") %>% 
  left_join(IMAE_num, by=c("ZPMD_IMAE"="ZCAIMAE")) %>% 
  group_by(CAPACNUM, ZPMD_IMAE) %>%
  summarize(n_meses_imae=n(), IMAE_ingreso=first(IMAE_ingreso), depto=first(depto)) %>% 
  group_by(CAPACNUM) %>% 
  mutate(
    n_imaes=n(),
    rank = row_number(-n_meses_imae),
    prop=n_meses_imae/sum(n_meses_imae)*100,
    cambio=if_else(rank==1,
      if_else(max(prop)!=100, 1, 0),
      NA),
    max_prop1=if_else(rank==1, prop, NA),
    max_prop2=if_else(rank==2, prop, NA),
    max_prop3=if_else(rank==3, prop, NA),
    prop_ingreso=if_else(ZPMD_IMAE==IMAE_ingreso, prop, NA),
    prop_ingreso=sum(prop_ingreso, na.rm=T),
    ingreso_max1=if_else(max_prop1==prop_ingreso, 1, 0),
    ingreso_max2=if_else(max_prop2==prop_ingreso, 1, 0),
    ingreso_max3=if_else(max_prop3==prop_ingreso, 1, 0)
    ) 
  
cambios_promedio_todos <- cambios_todos %>%
  filter(depto=="01",
         ZPMD_IMAE!="SENNIAD HEMO") %>% 
  mutate(
    n_imaes=n(),
    rank = row_number(-n_meses_imae),
    prop=n_meses_imae/sum(n_meses_imae)*100,
    cambio=if_else(rank==1,
      if_else(max(prop)!=100, 1, 0),
      NA),
    max_prop1=if_else(rank==1, prop, NA),
    max_prop2=if_else(rank==2, prop, NA),
    max_prop3=if_else(rank==3, prop, NA),
    prop_ingreso=if_else(ZPMD_IMAE==IMAE_ingreso, prop, NA),
    prop_ingreso=sum(prop_ingreso, na.rm=T),
    ingreso_max1=if_else(max_prop1==prop_ingreso, 1, 0),
    ingreso_max2=if_else(max_prop2==prop_ingreso, 1, 0),
    ingreso_max3=if_else(max_prop3==prop_ingreso, 1, 0)
    ) %>% 
  ungroup() %>% 
  summarise(
    "# facilities"=mean(n_imaes, na.rm = T),
    "% patients changing facility"=mean(cambio, na.rm = T)*100,
    "% patients spending most months at first facility"=mean(ingreso_max1, na.rm = T)*100,
    "% months at first facility"=mean(prop_ingreso, na.rm = T),
    "% months at most attended facility"=mean(max_prop1, na.rm = T),
    "% months at 2nd most attended facility"=mean(max_prop2, na.rm = T),
    "% months at 3rd most attended facility"=mean(max_prop3, na.rm = T),
    ) %>% 
  pivot_longer(cols = everything(), names_to = "Indicator", values_to="Mean")

cambios_sd_todos <- cambios_todos %>%
  filter(depto=="01",
         ZPMD_IMAE!="SENNIAD HEMO") %>% 
  mutate(
    n_imaes=n(),
    rank = row_number(-n_meses_imae),
    prop=n_meses_imae/sum(n_meses_imae)*100,
    cambio=if_else(rank==1,
      if_else(max(prop)!=100, 1, 0),
      NA),
    max_prop1=if_else(rank==1, prop, NA),
    max_prop2=if_else(rank==2, prop, NA),
    max_prop3=if_else(rank==3, prop, NA),
    prop_ingreso=if_else(ZPMD_IMAE==IMAE_ingreso, prop, NA),
    prop_ingreso=sum(prop_ingreso, na.rm=T),
    ingreso_max1=if_else(max_prop1==prop_ingreso, 1, 0),
    ingreso_max2=if_else(max_prop2==prop_ingreso, 1, 0),
    ingreso_max3=if_else(max_prop3==prop_ingreso, 1, 0)
    ) %>%
  filter(depto=="01",
         ZPMD_IMAE!="SENNIAD HEMO") %>% 
  ungroup() %>% 
  summarise(
    "# facilities"=sd(n_imaes, na.rm = T),
    "% patients changing facility"=NA,
    "% patients spending most months at first facility"=NA,
    "% months at first facility"=sd(prop_ingreso, na.rm = T),
    "% months at most attended facility"=sd(max_prop1, na.rm = T),
    "% months at 2nd most attended facility"=sd(max_prop2, na.rm = T),
    "% months at 3rd most attended facility"=sd(max_prop3, na.rm = T),
    ) %>% 
  pivot_longer(cols = everything(), names_to = "Indicator", values_to="SD")

tabla_cambios_todos <- full_join(cambios_promedio_todos, cambios_sd_todos, by="Indicator")


# Del centro ----
cambios_delcentro <- MENSUALES_HD %>%
  filter(PMD_ORIG=="Del centro") %>% 
  mutate(
  ZPMD_IMAE=if_else(ZPMD_IMAE=="HOSPITAL ITALIANO", "UNIVERSAL", ZPMD_IMAE),
  ZPMD_IMAE=if_else(ZPMD_IMAE=="IMPASA", "SMI - SERVICIO MEDICO INTEGRAL", ZPMD_IMAE),
  ) %>% 
  right_join(IMAE_ingreso, by="CAPACNUM") %>% 
  left_join(IMAE_num, by=c("ZPMD_IMAE"="ZCAIMAE")) %>% 
  group_by(CAPACNUM, ZPMD_IMAE) %>%
  summarize(n_meses_imae=n(), IMAE_ingreso=first(IMAE_ingreso), depto=first(depto)) %>% 
  group_by(CAPACNUM) %>% 
  mutate(
    n_imaes=n(),
    rank = row_number(-n_meses_imae),
    prop=n_meses_imae/sum(n_meses_imae)*100,
    cambio=if_else(rank==1,
      if_else(max(prop)!=100, 1, 0),
      NA),
    max_prop1=if_else(rank==1, prop, NA),
    max_prop2=if_else(rank==2, prop, NA),
    max_prop3=if_else(rank==3, prop, NA),
    prop_ingreso=if_else(ZPMD_IMAE==IMAE_ingreso, prop, NA),
    prop_ingreso=sum(prop_ingreso, na.rm=T),
    ingreso_max1=if_else(max_prop1==prop_ingreso, 1, 0),
    ingreso_max2=if_else(max_prop2==prop_ingreso, 1, 0),
    ingreso_max3=if_else(max_prop3==prop_ingreso, 1, 0)
    ) 
  
cambios_promedio_delcentro <- cambios_delcentro %>%
  filter(depto=="01",
         ZPMD_IMAE!="SENNIAD HEMO") %>% 
  mutate(
    n_imaes=n(),
    rank = row_number(-n_meses_imae),
    prop=n_meses_imae/sum(n_meses_imae)*100,
    cambio=if_else(rank==1,
      if_else(max(prop)!=100, 1, 0),
      NA),
    max_prop1=if_else(rank==1, prop, NA),
    max_prop2=if_else(rank==2, prop, NA),
    max_prop3=if_else(rank==3, prop, NA),
    prop_ingreso=if_else(ZPMD_IMAE==IMAE_ingreso, prop, NA),
    prop_ingreso=sum(prop_ingreso, na.rm=T),
    ingreso_max1=if_else(max_prop1==prop_ingreso, 1, 0),
    ingreso_max2=if_else(max_prop2==prop_ingreso, 1, 0),
    ingreso_max3=if_else(max_prop3==prop_ingreso, 1, 0)
    ) %>% 
  ungroup() %>% 
  summarise(
    "# facilities"=mean(n_imaes, na.rm = T),
    "% patients changing facility"=mean(cambio, na.rm = T)*100,
    "% patients spending most months at first facility"=mean(ingreso_max1, na.rm = T)*100,
    "% months at first facility"=mean(prop_ingreso, na.rm = T),
    "% months at most attended facility"=mean(max_prop1, na.rm = T),
    "% months at 2nd most attended facility"=mean(max_prop2, na.rm = T),
    "% months at 3rd most attended facility"=mean(max_prop3, na.rm = T),
    ) %>% 
  pivot_longer(cols = everything(), names_to = "Indicator", values_to="Mean")

cambios_sd_delcentro <- cambios_delcentro %>%
  filter(depto=="01",
         ZPMD_IMAE!="SENNIAD HEMO") %>% 
  mutate(
    n_imaes=n(),
    rank = row_number(-n_meses_imae),
    prop=n_meses_imae/sum(n_meses_imae)*100,
    cambio=if_else(rank==1,
      if_else(max(prop)!=100, 1, 0),
      NA),
    max_prop1=if_else(rank==1, prop, NA),
    max_prop2=if_else(rank==2, prop, NA),
    max_prop3=if_else(rank==3, prop, NA),
    prop_ingreso=if_else(ZPMD_IMAE==IMAE_ingreso, prop, NA),
    prop_ingreso=sum(prop_ingreso, na.rm=T),
    ingreso_max1=if_else(max_prop1==prop_ingreso, 1, 0),
    ingreso_max2=if_else(max_prop2==prop_ingreso, 1, 0),
    ingreso_max3=if_else(max_prop3==prop_ingreso, 1, 0)
    ) %>%
  filter(depto=="01",
         ZPMD_IMAE!="SENNIAD HEMO") %>% 
  ungroup() %>% 
  summarise(
    "# facilities"=sd(n_imaes, na.rm = T),
    "% patients changing facility"=NA,
    "% patients spending most months at first facility"=NA,
    "% months at first facility"=sd(prop_ingreso, na.rm = T),
    "% months at most attended facility"=sd(max_prop1, na.rm = T),
    "% months at 2nd most attended facility"=sd(max_prop2, na.rm = T),
    "% months at 3rd most attended facility"=sd(max_prop3, na.rm = T),
    ) %>% 
  pivot_longer(cols = everything(), names_to = "Indicator", values_to="SD")

tabla_cambios_delcentro <- full_join(cambios_promedio_delcentro, cambios_sd_delcentro, by="Indicator") %>% select(-Indicator)

# Todos y del centro

tabla_cambios <- cbind(tabla_cambios_todos, tabla_cambios_delcentro)

  


# % que cambia 
summary(cambios$cambio)

# Numero de imaes
summary(cambios$n_imaes)

# Proporcon at 1 max imae
summary(cambios$max_prop1)

# Proporcon at 2 max imae
summary(cambios$max_prop2)

# Proporcon at 3 max imae
summary(cambios$max_prop3)

# Proporcon at 1 max imae
summary(cambios$ingreso_max1)

# Proporcon at 2 max imae
summary(cambios$ingreso_max2)

# Proporcon at 3 max imae
summary(cambios$ingreso_max3)

summary(cambios$n_imaes)

cambios_ingreso <- cambios %>% 
  filter(imae_max==1) %>% 
  mutate(ingreso_max=if_else(ZPMD_IMAE==IMAE_ingreso, 1, 0))

summary(cambios_ingreso$ingreso_max)

cambios_max2 <- cambios %>%
  filter(imae_max==0) %>% 
  group_by(CAPACNUM) %>% 
  mutate(n_imaes2=n(),
         prop2=n_meses_imae/sum(n_meses_imae),
    max2_prop=max(prop2),
         imae_max2=if_else(prop==max2_prop, 1, 0),
         cambio2=if_else(max2_prop!=1, 1, 0)) 

print(xtable::xtable(tabla_cambios, file="tabla_cambios"), include.rownames = FALSE)

```
# Shares

```{r}



 table_shares <- Logit_INGRESOS %>% 
  filter(choice==1) %>% 
  #left_join(IMAE_num, by="ZCAIMAE") %>%
  mutate(tipo_imae2=case_when(tipo_imae=="INDEPENDIENTE" ~ "Indep",
                                tipo_imae=="PRIVADO" ~ "Priv Ins",
                                tipo_imae=="PUBLICO" ~ "Pub Ins")) %>%
  filter(depto=="01",
         ZCAIMAE!="SENNIAD HEMO") %>% 
  group_by(ZCAIMAE) %>%
  summarise(Frequency = n(), Type=first(tipo_imae2)) %>%
  mutate(Percentage = round(Frequency / sum(Frequency) * 100, 2),
         ZCAIMAE=str_to_title(ZCAIMAE)) %>%
  arrange(desc(Frequency)) %>%
  add_row(ZCAIMAE = "Total", Frequency = sum(.$Frequency), Percentage = 100) %>% 
  select(ZCAIMAE, Type, Frequency, Percentage)

 table_shares_tipo <- Logit_INGRESOS %>% 
  filter(choice==1) %>% 
  #left_join(IMAE_num, by="ZCAIMAE") %>%
  mutate(tipo_imae2=case_when(tipo_imae=="INDEPENDIENTE" ~ "Indep",
                                tipo_imae=="PRIVADO" ~ "Priv Ins",
                                tipo_imae=="PUBLICO" ~ "Pub Ins")) %>%
  filter(depto=="01",
         ZCAIMAE!="SENNIAD HEMO") %>% 
  group_by(tipo_imae2) %>%
  summarise(Frequency = n(), Type=first(tipo_imae2)) %>%
  mutate(Percentage = round(Frequency / sum(Frequency) * 100, 2)) %>%
  arrange(desc(Frequency)) %>%
  add_row(Type = "Total", Frequency = sum(.$Frequency), Percentage = 100) %>% 
  select(Type, Frequency, Percentage)
 
 print(xtable::xtable(table_shares_tipo, file="table_shares_tipo"), include.rownames = FALSE)


```

# A donde se cambian?

```{r}

# A donde se cambian los pacientes que ingresan en el período
cambios_donde <- MENSUALES_HD  %>% 
  
  # UNIVERSAL
  mutate(
    ZPMD_IMAE=if_else(ZPMD_IMAE=="HOSPITAL ITALIANO", "UNIVERSAL", ZPMD_IMAE),
    ZPMD_IMAE=if_else(ZPMD_IMAE=="IMPASA", "SMI - SERVICIO MEDICO INTEGRAL", ZPMD_IMAE),
    ) %>% 
   
  # IMAE DE INGRESO: Me quedo solo con los pacientes que ingresan en el período
  right_join(IMAE_ingreso, by="CAPACNUM") %>% 
  
  # CAIMAE
  left_join(IMAE_num, by=c("ZPMD_IMAE"="ZCAIMAE")) %>% 
  
  # FECHA DEL MES
  unite("fecha2", PMD_ANIO:PMD_MES, sep="-") %>% 
  mutate(fecha3=as.Date(paste(fecha2, "-01", sep=""))) %>% 
  
  # ORIGEN: CENTRO, MDEO y sin SENNIAD HEMO
  filter(PMD_ORIG=="Del centro",
         depto=="01",
         ZPMD_IMAE!="SENNIAD HEMO") %>%

  # Colapsar por paciente-IMAE
  arrange(fecha3) %>% 
  group_by(CAPACNUM, ZPMD_IMAE) %>%
  summarize(n_meses_imae=n(), IMAE_ingreso=first(IMAE_ingreso), 
            depto=first(depto),
            fecha3=last(fecha3)) %>%
  
  # Número de centros por paciente
  group_by(CAPACNUM) %>% 
  mutate(n_imaes=n_distinct(ZPMD_IMAE),
         orden=row_number(fecha3),
         tipo_imae=
  case_when(ZPMD_IMAE %in% c(IMAE_CENEU, IMAE_NEPHROS, IMAE_DIAVERUM, IMAE_SARI) ~ "Independent",
            ZPMD_IMAE %in% IMAE_PUBLICO ~ "Public",
            ZPMD_IMAE %in% IMAE_PRIVADO ~ "Private",
            TRUE ~ NA)) %>% 
  filter(n_imaes>1) %>% 
  pivot_wider(id_cols="CAPACNUM", names_from = "orden", names_prefix = "imae", values_from = "tipo_imae") %>% 
  group_by(imae1) %>% 
  summarise(total=n(), 
            imae2indep=sum(if_else(imae2=="Independent", 1, 0)),
            imae2priv=sum(if_else(imae2=="Private", 1, 0)),
            imae2pub=sum(if_else(imae2=="Public", 1, 0))) %>% 
  mutate(Independent=paste0(round(imae2indep/total*100, 2), "%"),
         Private=paste0(round(imae2priv/total*100, 2), "%"),
         Public=paste0(round(imae2pub/total*100, 2), "%")) %>% 
  select(-starts_with("imae2"))

# Del centro ----
cambios_donde <- MENSUALES_HD  %>% 
  
  # UNIVERSAL
  mutate(
    ZPMD_IMAE=if_else(ZPMD_IMAE=="HOSPITAL ITALIANO", "UNIVERSAL", ZPMD_IMAE),
    ZPMD_IMAE=if_else(ZPMD_IMAE=="IMPASA", "SMI - SERVICIO MEDICO INTEGRAL", ZPMD_IMAE),
    ) %>% 
  
  # ORIGEN: CENTRO, MDEO y sin SENNIAD HEMO
  filter(PMD_ORIG=="Del centro",
         depto=="01",
         ZPMD_IMAE!="SENNIAD HEMO") %>%
  
  # Tipo de IMAE
  mutate(
         tipo_imae=
  case_when(ZPMD_IMAE %in% c(IMAE_CENEU, IMAE_NEPHROS, IMAE_DIAVERUM, IMAE_SARI) ~ "Independent",
            ZPMD_IMAE %in% IMAE_PUBLICO ~ "Public",
            ZPMD_IMAE %in% IMAE_PRIVADO ~ "Private",
            TRUE ~ NA)) %>% 
  group_by(tipo_imae) %>% 
  summarise(Me=n()) %>% 
  mutate(Independent=paste0(round(imae2indep/total*100, 2), "%"),
         Private=paste0(round(imae2priv/total*100, 2), "%"),
         Public=paste0(round(imae2pub/total*100, 2), "%")) %>% 
  select(-starts_with("imae2"))

 print(xtable::xtable(cambios_donde, file="cambios_donde"), include.rownames = FALSE)


```

# ECH

```{r}
library(haven)
P_2016_Terceros <- read_sav("~/Proyecto Tesis/Databases/ECH/Base ECH 2016 formato SAV/P_2016_Terceros.sav")
View(P_2016_Terceros)

P_2016_Terceros %>% select(starts_with("e45"))

# Qué quiere decir "derecho a"?
table(P_2016_Terceros$e45_1, P_2016_Terceros$e45_1_2)
table(P_2016_Terceros$e45_2, P_2016_Terceros$e45_2_2)
table(P_2016_Terceros$e45_3, P_2016_Terceros$e45_3_2)
table(P_2016_Terceros$e45_4, P_2016_Terceros$e45_4_2)


# Tabla ECH ----
tabla_ECH <- P_2016_Terceros %>% 
  select(numero, nper, pesoano, e26, e27, 
         e45_1, e45_1_2, # ASSE
         e45_2, e45_2_2, #MUTUALISTA
         e45_3, e45_3_2, #SEGURO PRIVADO
         e45_4,  # CORPORATIVO
  e197, e197_1, e201, e201_1, e212, e211_1) %>%

  # TIENE DERECHO DE ASISTENCIA
  mutate(
    asse=case_when(
    e45_1==1~1,
    e45_1==2~0),
    mutualista=case_when(
      e45_2==1~1,
      e45_2==2~0),
    seguro=case_when(
      e45_3==1~1,
      e45_3==2~0),
    corporativo=case_when(
      e45_4==1~1,
      e45_4==2~0),
    tipo_inst=case_when(asse==1~"ASSE",
                   mutualista==1~"IAMC/IAMPP",
                   seguro==1~"SEGURO PRIVADO",
                   corporativo==1~"CORPORATIVO"),
    
  # SEXO
    female=case_when(
      e26==2~1,
      e26==1~0),
  
  # EDUCACION
  secondary=if_else(e201==2,
                     e201_1==1, 1, 0)
  ) %>% 
  
  # COLAPSO
  group_by(tipo_inst) %>% 
  summarise(
    female_ECH=paste0(round(weighted.mean(female, pesoano)*100, 2), "%"),
    age_ECH=round(weighted.mean(e27, pesoano),2),
    secondary_ECH=paste0(round(weighted.mean(secondary, pesoano)*100, 2), "%"),
    )

         
# Tabla INGRESOS_HD
## Usando INGRESOS_HD importado desde X_imae

tabla_ING <- INGRESOS_HD %>% 
  mutate(female=case_when(CASEXO=="F"~1,
                          CASEXO=="M"~0)) %>% 
  group_by(tipo_inst) %>%
    summarise(
              female_ING=paste0(round(mean(female, na.rm = T)*100, 2), "%"),
      age_ING=round(mean(CASEDADA, na.rm = T), 2),
      secondary_ING=paste0(round(mean(edu_sec_or_more)*100, 2), "%"),

      )

tabla_ING_ECH <- tabla_ING %>% left_join(tabla_ECH, by="tipo_inst")

print(xtable::xtable(tabla_ING_ECH, file="tabla_ING_ECH"), include.rownames = FALSE)
```

```{r}
borrar <- INGRESOS_HD %>%
  left_join(IMAE_num, join_by("ZCAIMAE")) %>% 
  filter(depto=="01",
         ZCAIMAE!="SENNIAD HEMO")

n_distinct(borrar$CAPACNUM)
```

