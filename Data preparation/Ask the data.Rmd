---
title: "Ask the data"
author: "Rodrigo Surraco"
date: "2024-04-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1. Los pacientes descompensados se quedan más en el centro de su prestador?

```{r descom}

occupancy <- read_csv("OCCUPANCY.CSV")
INGRESOS_HD2 <- read_csv("INGRESOS_HD2.csv")

DATA <- 
  left_join(occupancy, INGRESOS_HD2, by=c("mes_solicitud", "ZCAIMAE")) %>% 
  dummy_cols(select_columns = c("tipo_inst", "SCDESU")) %>% 
  mutate(ingresos=if_else(is.na(CAPACNUM), 0, 1))

DATA %>% group_by(SCDESU) %>% summarise(inst_imae=mean(inst_imae, na.rm=T))
```

No.

# 2. Los centros admiten más pacientes descompensados o de prestadores públicos cuanto más espacio tienen (seleccionan)?

```{r occupancy}

occupancy <- read_csv("OCCUPANCY.CSV")
INGRESOS_HD2 <- read_csv("INGRESOS_HD2.csv")

DATA <- 
  left_join(occupancy, INGRESOS_HD2, by=c("mes_solicitud", "ZCAIMAE")) %>% 
  dummy_cols(select_columns = c("tipo_inst", "SCDESU")) %>% 
  mutate(ingresos=if_else(is.na(CAPACNUM), 0, 1))

DATA2 <- DATA  %>% 
  group_by(mes_solicitud, ZCAIMAE) %>% 
  summarise(slack=mean(slack, na.rm=T),
            slack_perc=mean(slack_perc, na.rm=T),
            tipo_inst_ASSE=mean(tipo_inst_ASSE, na.rm=T),
            SCDESU_S=mean(SCDESU_S, na.rm=T),
            ingresos=sum(ingresos))

DATA2 %>% ungroup() %>% select(-c(mes_solicitud, ZCAIMAE)) %>% cor(use = "pairwise.complete.obs")
```

No.


# 3. Qué centros admiten más pacientes descompensados y de ASSE?

```{r occupancy}

occupancy <- read_csv("OCCUPANCY.CSV")
INGRESOS_HD2 <- read_csv("INGRESOS_HD2.csv")

DATA <- 
  left_join(occupancy, INGRESOS_HD2, by=c("mes_solicitud", "ZCAIMAE")) %>% 
  dummy_cols(select_columns = c("tipo_inst", "SCDESU")) %>% 
  mutate(ingresos=if_else(is.na(CAPACNUM), 0, 1))

DATA3 <- DATA  %>% 
  group_by(ZCAIMAE) %>% 
  summarise(slack=mean(slack, na.rm=T),
            slack_perc=mean(slack_perc, na.rm=T),
            tipo_inst_ASSE=mean(tipo_inst_ASSE, na.rm=T),
            SCDESU_S=mean(SCDESU_S, na.rm=T),
            ingresos=sum(ingresos))

DATA3
```

No.

# 4. Qué pacientes están en INGRESOS y en MENSUALES e SESIONES?

```{r}

aborrar <- left_join(MENSUALES_HD, INGRESOS_HD, by="CAPACNUM") %>% 
  mutate(ingreso=if_else(is.na(CASEDADA), 1, 0))

summary(aborrar$ingreso)

aborrar2 <- left_join(SESIONES_HD, INGRESOS_HD, by="CAPACNUM") %>% 
  mutate(ingreso=if_else(is.na(CASEDADA), 1, 0))

summary(aborrar2$ingreso)
```


# 5. Qué pasa si uso las variables de ocupación?

```{r}

imae <- INGRESOS_HD %>% group_by(CAIMAE) %>% summarise(CAIMAE=first(CAIMAE),
                                                       ZCAIMAE=first(ZCAIMAE))

congestion <- INFORMES_IMAES_HD %>%
  left_join(imae, by="CAIMAE") %>% 
  left_join(IMAE_num, by="ZCAIMAE") %>% 
  rowwise() %>% 
  mutate(
    #Promedio pacientes por turno en cada dia
    suma_lunes= sum(c(DNLU1O, DNLU2O, DNLU3O, DNLU4O), na.rm = T),
    Nlunes= suma_lunes/DNLUT,
    
    suma_martes=sum(c(DNMA1O, DNMA2O, DNMA3O, DNMA4O), na.rm = T),
    Nmartes= suma_martes/DNMAT,
    
    suma_miercoles=sum(c(DNMI1O, DNMI2O, DNMI3O, DNMI4O), na.rm = T),
    Nmiercoles= suma_miercoles/DNMIT,
    
    suma_jueves= sum(c(DNJU1O, DNJU2O, DNJU3O, DNJU4O), na.rm = T),
    Njueves= suma_jueves/DNJUT,
    
    suma_viernes=sum(c(DNVI1O, DNVI2O, DNVI3O, DNVI4O), na.rm = T),
    Nviernes=suma_viernes/DNVIT,
    
    suma_sabado=sum(c(DNSA1O, DNSA2O, DNSA3O, DNSA4O), na.rm = T),
    Nsabado= suma_sabado/DNSAT,
    
    #Suma por conjunto de dias
    sumaLMV=sum(c(suma_lunes, suma_miercoles, suma_viernes), na.rm = T),
    sumaMJS=sum(c(suma_martes, suma_jueves, suma_sabado), na.rm = T),
    promedio_suma=mean(c(sumaLMV, sumaMJS), na.rm=T),
    
    #Promedio conjunto de dias
    Nlmv=mean(c(Nlunes, Nmiercoles, Nviernes), na.rm = T),
    Nmjs=mean(c(Nmartes, Njueves, Nsabado), na.rm = T),
    
    Nmean=mean(c(Nlmv, Nmjs), na.rm = T),
    promedio_turnos_semana=
      mean(c(DNLUT, DNMIT, DNVIT), na.rm = T) +
      mean(c(DNMAT, DNJUT, DNSAT), na.rm = T),
    
    #Plunes= sum(c(DPLU1O, DPLU2O, DPLU3O, DPLU4O), na.rm = T)/DPLUT,
    #Pmartes= sum(c(DPMA1O, DPMA2O, DPMA3O, DPMA4O), na.rm = T)/DPMAT,
    #Pmiercoles= sum(c(DPMI1O, DPMI2O, DPMI3O, DPMI4O), na.rm = T)/DPMIT,
    #Pjueves= sum(c(DPJU1O, DPJU2O, DPJU3O, DPJU4O), na.rm = T)/DPJUT,
    #Pviernes= sum(c(DPVI1O, DPVI2O, DPVI3O, DPVI4O), na.rm = T)/DPVIT,
    #Psabado= sum(c(DPSA1O, DPSA2O, DPSA3O, DPSA4O), na.rm = T)/DPSAT,
    #
    #Plmv=mean(c(Plunes, Pmiercoles, Pviernes), na.rm = T),
    #Pmjs=mean(c(Pmartes, Pjueves, Psabado), na.rm = T),
    
    slack=CAHMSPBN-Nmean,
    slack_perc=slack/CAHMSPBN*100,
    
    slack2=
           if_else(slack>=10,
                   (CAHMSPBN/promedio_turnos_semana)-Nmean, slack),
    slack_perc2=slack2/CAHMSPBN*100) %>% 
  unite("fecha2", CAANIO:CAMES, sep="-") %>% 
  mutate(fecha3=as.Date(paste(fecha2, "-01", sep="")),
         mes_solicitud=format(fecha3, "%Y-%m")) %>% 
  mutate(
    tipo_imae=
      case_when(ZCAIMAE %in% c(IMAE_CENEU, IMAE_NEPHROS, IMAE_DIAVERUM, IMAE_SARI) ~ "INDEPENDIENTE",
                ZCAIMAE %in% IMAE_PUBLICO ~ "PUBLICO",
                ZCAIMAE %in% IMAE_PRIVADO ~ "PRIVADO",
                TRUE ~ NA)) %>%
    filter(depto=="01", # Filter for facilities in Montevideo
         ZCAIMAE!="SENNIAD HEMO",
         Nmean!=0,
         slack!=-102) %>% #Not pediatric
  select(slack2, slack_perc2, 
         ZCAIMAE, mes_solicitud, depto)

summary(congestion$slack)
summary(congestion$slack2)


DATA <- 
  left_join(occupancy, INGRESOS_HD2, by=c("mes_solicitud", "ZCAIMAE")) %>% 
  dummy_cols(select_columns = c("tipo_inst", "SCDESU")) %>% 
  mutate(ingresos=if_else(is.na(CAPACNUM), 0, 1))

DATA3 <- DATA  %>% 
  group_by(ZCAIMAE) %>% 
  summarise(slack=mean(slack, na.rm=T),
            slack_perc=mean(slack_perc, na.rm=T),
            tipo_inst_ASSE=mean(tipo_inst_ASSE, na.rm=T),
            SCDESU_S=mean(SCDESU_S, na.rm=T),
            ingresos=sum(ingresos),
            inst_imae=mean(inst_imae, na.rm=T))

INGRESOS_HD2 %>% group_by(ZCAIMAE) %>%
  summarise(
            inst_imae=mean(inst_imae, na.rm=T))

```


# 6. How much dialysis time?

```{r}

SESIONES_HD <- 
  read_sav("C:/Users/julie/OneDrive/Documentos/Proyecto Tesis/Databases/SESIONES HD.sav") 

head(SESIONES_HD, n=20)

summary(SESIONES_HD$DHORAS)



```


# 7. Complicaciones en la dialisis:

```{r}
table(SESIONES_HD$ZDCOMPD0)
table(SESIONES_HD$DCOMP)


aborrar <- SESIONES_HD %>% filter(DCOMPD0==184020127)
```


# 8. Where do ASSE patients go?

```{r}

asse <- INGRESOS_HD %>% filter(ZCASINST=="ASSE") %>% select(ZCAIMAE)

table(asse$ZCAIMAE) %>% as.data.frame()


```
# 9. Patients by functionality 

```{r}
table(INGRESOS_HD$exa_capacidad)

```

# 10. How many in waiting list for transplant?

```{r}
table(MENSUALES_HD$DLISTATR)

aborrar <- MENSUALES_HD %>% select(CAPACNUM, PMD_ANIO, PMD_ANIO, PMD_MES, DLISTATR)
```

Solo hay datos para diciembre, ¿por qué? (Preguntar a Opertti).

# 11. Delta peso 

```{r}
dP <- SESIONES_HD %>% 
  mutate(DPESOSE=case_when(DPESOSE==999.00 ~ NA,
                           .default = as.numeric(DPESOSE)),
         DPESOPO=case_when(DPESOPO==999.00 ~ NA,
                           .default = as.numeric(DPESOPO)),
         dife=DPESOPO-DPESOSE,
         peso=case_when(abs(dife)<=0.5 ~ 1,
                        abs(dife)>0.5 ~ 0,
                        is.na(dife) ~ NA)) %>% 
  rename(ZCAIMAE=ZPMD_IMAE)



# Reorder "anio" in increasing order
dP$anio <- factor(dP$PMD_ANIO, levels = sort(unique(dP$PMD_ANIO)))

# Reorder "ZCAIMAE" alphabetically
dP$ZCAIMAE <- factor(dP$ZCAIMAE, levels = sort(unique(dP$ZCAIMAE)))

# Set reference levels for anio, ZCAIMAE and CAPACNUM
base$anio <- relevel(base$anio, ref = "2004")
base$ZCAIMAE <- relevel(base$ZCAIMAE, ref = "ASOCIACION ESPAÑOLA")
base$CAPACNUM <- relevel(base$CAPACNUM, ref="344677")

dP <- dP %>% select(peso, CAPACNUM, DPESOPR, ZCAIMAE, anio, dife) %>%
  unite("ZCAIMAEanio", ZCAIMAE:anio, sep=":", remove = FALSE)


library(peakRAM)
library(fixest)
peakRAM({
  m_dP <- feols(peso ~ DPESOPR | ZCAIMAEanio + CAPACNUM, dP)
})

predict(m_dP)
delta_p <- fixef(m_dP)$ZCAIMAEanio %>% as.data.frame() %>% 
  rownames_to_column("ZCAIMAEanio")

colnames(delta_p) <- c("ZCAIMAEanio", "value")

delta_p <- delta_p %>%
  separate(ZCAIMAEanio, sep = ":", into = c("ZCAIMAE", "anio"))

m_dP2 <- lm(dife ~ - 1 + 
               CAPACNUM +
               DPESOPRE +
               ZCAIMAE:anio, 
             data=base)

summary(m_dP)
summary(m_dP2)

aborrar2 <-stack(aborrar)

```


